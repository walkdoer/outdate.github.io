<!doctype html>
<html class="theme-next use-motion ">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>




  <meta name="keywords" content="javascript,编程语言," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="「You don’t konw js」对于有一定编程经验，对javascript有足够开发经验的人来讲，这本书简直就是福音，javascript很有“群众基础 ”，但同时也是被误解最多的语言之一。对于我个人而言，在读这本书的过程中，才发现自己对javascript也有许多误解的地方，收益匪浅。另外，这本书在Github上的关注度非常高, 作者Kyle Simpson能将复杂的概念，用一种非常舒服的">
<meta property="og:type" content="article">
<meta property="og:title" content="You don't konw js 之 Async & Performance 读书笔记">
<meta property="og:url" content="http://zhangmhao.github.io/2015/05/05/You-don't-know-js--Async-and-Performance-读书笔记/index.html">
<meta property="og:site_name" content="Code Me">
<meta property="og:description" content="「You don’t konw js」对于有一定编程经验，对javascript有足够开发经验的人来讲，这本书简直就是福音，javascript很有“群众基础 ”，但同时也是被误解最多的语言之一。对于我个人而言，在读这本书的过程中，才发现自己对javascript也有许多误解的地方，收益匪浅。另外，这本书在Github上的关注度非常高, 作者Kyle Simpson能将复杂的概念，用一种非常舒服的">
<meta property="og:updated_time" content="2015-09-22T14:12:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="You don't konw js 之 Async & Performance 读书笔记">
<meta name="twitter:description" content="「You don’t konw js」对于有一定编程经验，对javascript有足够开发经验的人来讲，这本书简直就是福音，javascript很有“群众基础 ”，但同时也是被误解最多的语言之一。对于我个人而言，在读这本书的过程中，才发现自己对javascript也有许多误解的地方，收益匪浅。另外，这本书在Github上的关注度非常高, 作者Kyle Simpson能将复杂的概念，用一种非常舒服的">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post'
  };
</script>

  <title> You don't konw js 之 Async & Performance 读书笔记 | Code Me </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Code Me</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              You don't konw js 之 Async & Performance 读书笔记
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-05-05T00:00:00+08:00" content="2015-05-05">
            2015-05-05
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/读书笔记/" itemprop="url" rel="index">
                  <span itemprop="name">读书笔记</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>「<a href="https://github.com/getify/You-Dont-Know-JS" target="_blank" rel="external">You don’t konw js</a>」对于有一定编程经验，对javascript有足够开发经验的人来讲，这本书简直就是福音，javascript很有“群众基础 ”，但同时也是被误解最多的语言之一。对于我个人而言，在读这本书的过程中，才发现自己对javascript也有许多误解的地方，收益匪浅。另外，这本书在Github上的关注度非常高, 作者<a href="http://getify.me/" target="_blank" rel="external">Kyle Simpson</a>能将复杂的概念，用一种非常舒服的逻辑给你娓娓道来。</p>
<p>这一篇是这个系列的其中一个本 <a href="https://github.com/getify/You-Dont-Know-JS/blob/master/async%20&amp;%20performance/README.md#you-dont-know-js-async--performance" target="_blank" rel="external">You Don’t Know JS: Async &amp; Performance</a>的读书笔记。</p>
<h3 id="Chapter1_:_Asynchrony:_Now_&amp;_Later">Chapter1 : Asynchrony: Now &amp; Later</h3><h4 id="Event_Loop">Event Loop</h4><p>如果要理解异步，Event Loop是一个重要的概念</p>
<p>摘录出书中描述event loop的伪代码</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `eventLoop` is an array that acts as a queue (first-in, first-out)</span></span><br><span class="line"><span class="keyword">var</span> eventLoop = [ ];</span><br><span class="line"><span class="keyword">var</span> <span class="keyword">event</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keep going "forever"</span></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// perform a "tick"</span></span><br><span class="line">    <span class="keyword">if</span> (eventLoop.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// get the next event in the queue</span></span><br><span class="line">        <span class="keyword">event</span> = eventLoop.shift();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// now, execute the next event</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">event</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            reportError(err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中while的每一次迭代叫做<code>tick</code>，事件按照顺序逐个执行。</p>
<blockquote>
<p>At any given moment, only one event can be processed from the queue at a time.<br>常见的setTimeout其实就是在时间过期的时候，callback函数就会被插入到Event loop queue中。</p>
</blockquote>
<h4 id="并行，并发">并行，并发</h4><p>并行相对于串行，指同一时刻处理多个任务(物理上的同时发生)，而并发指的是逻辑上的同时发生，而下降到物理层面（处理器），有可能是串行的。<br>js只有单线程，所以不需要考虑多线程并行(parallel thread)时遇到的问题。而并发(concurrency)在js中是存在的。</p>
<blockquote>
<p>Concurrency is when two or more chains of events interleave over time, such that from a high-level perspective, they appear to be running simultaneously (even though at any given moment only one event is being processed).</p>
</blockquote>
<p>以常见的滚动加载为例，这个例子中有两个Process, 滚动发起请求onScroll 和 处理响应结果 onResponse, 这两个是并发的。</p>
<p>“Process” 1 (onscroll events):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onscroll, request <span class="number">1</span></span><br><span class="line">onscroll, request <span class="number">2</span></span><br><span class="line">onscroll, request <span class="number">3</span></span><br><span class="line">onscroll, request <span class="number">4</span></span><br><span class="line">onscroll, request <span class="number">5</span></span><br><span class="line">onscroll, request <span class="number">6</span></span><br><span class="line">onscroll, request <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>“Process” 2 (Ajax response events):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">response <span class="number">1</span></span><br><span class="line">response <span class="number">2</span></span><br><span class="line">response <span class="number">3</span></span><br><span class="line">response <span class="number">4</span></span><br><span class="line">response <span class="number">5</span></span><br><span class="line">response <span class="number">6</span></span><br><span class="line">response <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>如果将这两个Process放入真实的时间线中，是有可能“<strong>同时发生</strong>”的，这里之所以给同时发生加上引号，是因为根据Event loop的定义，真正意义的同时发生是不可能的，还是按照序列的排队来执行的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">onscroll, request <span class="number">1</span></span><br><span class="line">onscroll, request <span class="number">2</span>          response <span class="number">1</span></span><br><span class="line">onscroll, request <span class="number">3</span>          response <span class="number">2</span></span><br><span class="line">response <span class="number">3</span></span><br><span class="line">onscroll, request <span class="number">4</span></span><br><span class="line">onscroll, request <span class="number">5</span></span><br><span class="line">onscroll, request <span class="number">6</span>          response <span class="number">4</span></span><br><span class="line">onscroll, request <span class="number">7</span></span><br><span class="line">response <span class="number">6</span></span><br><span class="line">response <span class="number">5</span></span><br><span class="line">response <span class="number">7</span></span><br></pre></td></tr></table></figure>
<h4 id="ES6中的Job_queue">ES6中的Job queue</h4><blockquote>
<p>Jobs are kind of like the spirit of the setTimeout(..0) hack, but implemented in such a way as to have a much more well-defined and guaranteed ordering: later, but as soon as possible.</p>
</blockquote>
<h3 id="Chapter2:_Callback">Chapter2: Callback</h3><blockquote>
<p>Callbacks are the fundamental unit of asynchrony in JS. But they’re not enough for the evolving landscape of async programming as JS matures.<br>First, our brains plan things out in sequential, blocking, single-threaded semantic ways, but callbacks express asynchronous flow in a rather nonlinear, nonsequential way, which makes reasoning properly about such code much harder. Bad to reason about code is bad code that leads to bad bugs.</p>
</blockquote>
<p><strong> callback hell</strong></p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">listen<span class="list">( <span class="string">"click"</span>, function handler<span class="list">(<span class="keyword">evt</span>)</span>&#123;</span><br><span class="line">    setTimeout<span class="list">( <span class="keyword">function</span> request<span class="list">()</span>&#123;</span><br><span class="line">        ajax<span class="list">( <span class="string">"http://some.url.1"</span>, function response<span class="list">(<span class="keyword">text</span>)</span>&#123;</span><br><span class="line">            if <span class="list">(<span class="keyword">text</span> == <span class="string">"hello"</span>)</span> &#123;</span><br><span class="line">                handler<span class="list">()</span><span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">            else if <span class="list">(<span class="keyword">text</span> == <span class="string">"world"</span>)</span> &#123;</span><br><span class="line">                request<span class="list">()</span><span class="comment">;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; )</span><span class="comment">;</span></span><br><span class="line">    &#125;, <span class="number">500</span>)</span> <span class="comment">;</span></span><br><span class="line">&#125; )</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>改造方法：</p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">listen( <span class="string">"click"</span>, handler );</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span><span class="params">()</span> &#123;</span></span><br><span class="line">    setTimeout( request, <span class="number">500</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">request</span><span class="params">()</span>&#123;</span></span><br><span class="line">    ajax( <span class="string">"http://some.url.1"</span>, response );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">(text)</span>&#123;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">text</span> == <span class="string">"hello"</span>) &#123;</span><br><span class="line">        handler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">text</span> == <span class="string">"world"</span>) &#123;</span><br><span class="line">        request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>our sequential, blocking brain planning behaviors just don’t map well onto callback-oriented async code? That’s the first major deficiency to articulate about callbacks: they express asynchrony in code in ways our brains have to fight just to keep in sync with (pun intended!).</p>
</blockquote>
<p>当然，上面的方法虽然看起来没有嵌套了，但实际并没有解决根本的问题，我们依旧难以流畅的阅读代码。所以，javascript在发展的过程中，ES6也提出了更多的解决方案，这个后面再继续。我们先来看callback存在的其他问题。</p>
<h4 id="callback的信任问题">callback的信任问题</h4><p>当我们调用第三方模块的API时，我们无法保证这些模块对回调的处理永远正确的（第三方组件的升级），例如</p>
<ul>
<li>没有调用回调函数</li>
<li>调用多次</li>
<li>参数出现问题</li>
<li>没有抛出发生的错误。</li>
</ul>
<p>这就是信任问题，要规避这些问题，就必须写一些代码来防止这些错误的发生。作者在书中举了一个例子</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用第三方的统计平台的API，记录完之后在扣信用卡，和展示成功页面</span></span><br><span class="line">analytics.trackPurchase( purchaseData, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    chargeCreditCard();</span><br><span class="line">    displayThankyouPage();</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<p>但是由于统计平台的的API误升级，导致了多次调用回调函数，从而造成用户的信用卡被多次扣费。规避的方式也简单，只要增加一个全局变量来判断即可</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tracked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">analytics.trackPurchase( purchaseData, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tracked) &#123;</span><br><span class="line">        tracked = <span class="literal">true</span>;</span><br><span class="line">        chargeCreditCard();</span><br><span class="line">        displayThankyouPage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<p><strong>保证异步的调用顺序</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asyncify</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> orig_fn = fn,</span><br><span class="line">        intv = setTimeout( <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            intv = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (fn) fn();</span><br><span class="line">        &#125;, <span class="number">0</span> )</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    fn = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// firing too quickly, before `intv` timer has fired to</span></span><br><span class="line">        <span class="comment">// indicate async turn has passed?</span></span><br><span class="line">        <span class="keyword">if</span> (intv) &#123;</span><br><span class="line">            fn = orig_fn.bind.apply(</span><br><span class="line">                orig_fn,</span><br><span class="line">                <span class="comment">// add the wrapper's `this` to the `bind(..)`</span></span><br><span class="line">                <span class="comment">// call parameters, as well as currying any</span></span><br><span class="line">                <span class="comment">// passed in parameters</span></span><br><span class="line">                [<span class="keyword">this</span>].concat( [].slice.call( <span class="built_in">arguments</span> ) )</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// already async</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// invoke original function</span></span><br><span class="line">            orig_fn.apply( <span class="keyword">this</span>, <span class="built_in">arguments</span> );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Chapter_3_Promises">Chapter 3 Promises</h3><blockquote>
<p>What if instead of handing the continuation of our program to another party, we could expect it to return us a capability to know when its task finishes, and then our code could decide what to do next? This paradigm is called Promises.<br>Promises are an easily repeatable mechanism for encapsulating and composing future values.<br>flow-control mechanism</p>
<p>Promises are awesome. Use them. They solve the inversion of control issues that plague us with callbacks-only code.</p>
<p>They don’t get rid of callbacks, they just redirect the orchestration of those callbacks to a trustable intermediary mechanism that sits between us and another utility.<br>Promise chains also begin to address (though certainly not perfectly) a better way of expressing async flow in sequential fashion, </p>
</blockquote>
<h4 id="Promise如何解决信任问题">Promise如何解决信任问题</h4><h5 id="确定的执行顺序">确定的执行顺序</h5><p><strong>过早调用</strong> 当你在Promise对象上调用<code>then</code>的时候，不管Promise是不是已经resolve，都不会是同步运行的，所以可以避免运行顺序导致的竞态问题。<br><strong>调用顺序</strong> 当Promise resolve的时候，所有通过<code>then</code>注册的callback会按照顺序调用，callback中发生的事情不会影响其他callback</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p.then( <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    p.then( <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log( <span class="string">"C"</span> );</span><br><span class="line">    &#125; );</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">"A"</span> );</span><br><span class="line">&#125; );</span><br><span class="line">p.then( <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">"B"</span> );</span><br><span class="line">&#125; );</span><br><span class="line"><span class="comment">// A B C</span></span><br></pre></td></tr></table></figure>
<p><strong>确保返回参数是Promise对象</strong>  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// don't just do this:</span></span><br><span class="line">foo( <span class="number">42</span> )</span><br><span class="line">.then( <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( v );</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// instead, do this:</span></span><br><span class="line"><span class="built_in">Promise</span>.resolve( foo( <span class="number">42</span> ) )</span><br><span class="line">.then( <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( v );</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h4 id="Chain_Flow">Chain Flow</h4><h5 id="Terminology:_Resolve,_Fulfill,_and_Reject">Terminology: Resolve, Fulfill, and Reject</h5><p>作者讲了如何使用这几个单词，为什么是使用resolve而不是fulfill？但是看完之后不是特别理解，所以后面再补充。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( msg );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rejected</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error( err );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.then(</span><br><span class="line">    fulfilled,</span><br><span class="line">    rejected</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="Error_Handling">Error Handling</h4><p>一般错误处理使用<code>try-catch</code>，但是由于try-catch不支持异步，所以无法捕抓到异步运行函数的错误。</p>
<p>回调函数中，有一个标准叫做  <code>error-first callback</code>, 广泛应用于node的api种，例如</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs.readFile(path, <span class="function"><span class="keyword">function</span> <span class="params">(err, content)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">//处理错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>而在Promise中，采用的是  <code>split callbacks</code> ; 一个函数负责处理”fulfillment” , 另外一个处理”rejection”</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.reject( <span class="string">"Oops"</span> );</span><br><span class="line"></span><br><span class="line">p.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// never gets here</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rejected</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log( err ); <span class="comment">// "Oops"</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Promise的错误处理还有一些需要注意的地方，看下面这个例子: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve( <span class="number">42</span> );</span><br><span class="line"></span><br><span class="line">p.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// numbers don't have string functions,</span></span><br><span class="line">        <span class="comment">// so will throw an error</span></span><br><span class="line">        <span class="built_in">console</span>.log( msg.toLowerCase() );</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rejected</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// never gets here</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>其中的错误处理函数 是永远不会运行的, 因为rejected函数是提供给p这个promise的，而promise一旦resolve，就是immutable的，所以如果要处理这个错误，就只能留给 p.then() 执行后返回的新的promise.</p>
<p>如果要处理这种情况，按照Promise的定义</p>
<blockquote>
<p>The then(null,function(err){ .. }) pattern – only handling rejections (if any) but letting fulfillments pass through – has a shortcut in the API: catch(function(err){ .. }).</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve( <span class="number">42</span> );</span><br><span class="line"></span><br><span class="line">p.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// numbers don't have string functions,</span></span><br><span class="line">        <span class="comment">// so will throw an error</span></span><br><span class="line">        <span class="built_in">console</span>.log( msg.toLowerCase() );</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.catch( handleErrors );</span><br></pre></td></tr></table></figure>
<p>到了这里，问题还没有完全的解决，因为handleErrors函数也有可能会出错。继续.catch()多一个错误处理函数也是行不通的。因为另一个错误处理函数也会报错。解决的办法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve( <span class="number">42</span> );</span><br><span class="line"></span><br><span class="line">p.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// numbers don't have string functions,</span></span><br><span class="line">        <span class="comment">// so will throw an error</span></span><br><span class="line">        <span class="built_in">console</span>.log( msg.toLowerCase() );</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">.done( <span class="literal">null</span>, handleErrors );</span><br><span class="line"></span><br><span class="line"><span class="comment">// if `handleErrors(..)` caused its own exception, it would</span></span><br><span class="line"><span class="comment">// be thrown globally here</span></span><br></pre></td></tr></table></figure>
<p>如果handleErrors发生异常，那么会直接抛出错误， 从而避免错误被开发者忽略。但是done并不是ES6的标准<br>，如果要使用这种方式，就只能自己封装，或者使用一些比较可靠的Promise库</p>
<p>那么，难道没有其他方式了吗？作者在这一章的最后给出了一个解决方案，但是这个同样是ES6不支持的，只是比上面的解决办法更加优雅一些</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.reject( <span class="string">"Oops"</span> ).defer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// `foo(..)` is Promise-aware</span></span><br><span class="line">foo( <span class="number">42</span> )</span><br><span class="line">.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fulfilled</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rejected</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// handle `foo(..)` error</span></span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>The promise returned from foo(..) gets an error handler attached right away, so it’s implicitly opted out and no global reporting for it occurs either.<br>But the promise returned from the then(..) call has no defer() or error handler attached, so if it rejects (from inside either resolution handler), then it will be reported to the developer console as an uncaught error.</p>
</blockquote>
<h4 id="Promise_Patterns">Promise Patterns</h4><h5 id="Promise-all([_-_])">Promise.all([ .. ])</h5><p>当所有的Promsie都resolve的时候，则继续流程，其中有一个rejected，则进入错误处理函数。与promise resolve的顺序无关，则要全部完成即满足条件，继续流程。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// `request(..)` is a Promise-aware Ajax utility,</span></span><br><span class="line"><span class="comment">// like we defined earlier in the chapter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = request( <span class="string">"http://some.url.1/"</span> );</span><br><span class="line"><span class="keyword">var</span> p2 = request( <span class="string">"http://some.url.2/"</span> );</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all( [p1,p2] )</span><br><span class="line">.then( <span class="function"><span class="keyword">function</span>(<span class="params">msgs</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// both `p1` and `p2` fulfill and pass in</span></span><br><span class="line">    <span class="comment">// their messages here</span></span><br><span class="line">    <span class="keyword">return</span> request(</span><br><span class="line">        <span class="string">"http://some.url.3/?v="</span> + msgs.join(<span class="string">","</span>)</span><br><span class="line">    );</span><br><span class="line">&#125; )</span><br><span class="line">.then( <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log( msg );</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h5 id="Promise-race([_-_])">Promise.race([ .. ])</h5><p>同时有多个Promise，只取最先resolve的promise，其他都抛弃。而只要其中一个rejected，则会直接reject。这一点和<code>Promise.all()</code>是一样的</p>
<h4 id="Promise_Limitations">Promise Limitations</h4><ul>
<li>Sequence Error Handling</li>
<li>Single Value</li>
</ul>
<h3 id="Chapter_4:_Generators">Chapter 4: Generators</h3><blockquote>
<p>Generators are a new ES6 function type that does not run-to-completion like normal functions. Instead, the generator can be paused in mid-completion (entirely preserving its state), and it can later be resumed from where it left off.<br>This pause/resume interchange is cooperative rather than preemptive, which means that the generator has the sole capability to pause itself, using the yield keyword, and yet the iterator that controls the generator has the sole capability (via next(..)) to resume the generator.<br><strong>The yield / next(..) duality is not just a control mechanism, it’s actually a two-way message passing mechanism.</strong> A yield .. expression essentially pauses waiting for a value, and the next next(..) call passes a value (or implicit undefined) back to that paused yield expression.</p>
<p><strong>The key benefit of generators related to async flow control is that the code inside a generator expresses a sequence of steps for the task in a naturally sync/sequential fashion. </strong> The trick is that we essentially hide potential asynchrony behind the yield keyword – moving the asynchrony to the code where the generator’s iterator is controlled.</p>
<p>In other words, <strong>generators preserve a sequential, synchronous, blocking code pattern for async code, which lets our brains reason about the code much more naturally,</strong> addressing one of the two key drawbacks of callback-based async.</p>
</blockquote>
<p>generator的理念很简单，就是可以中断函数的执行，然后重新开始。看一下简单的例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    x++;</span><br><span class="line">    <span class="keyword">yield</span>; <span class="comment">// pause!</span></span><br><span class="line">    <span class="built_in">console</span>.log( <span class="string">"x:"</span>, x );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    x++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// construct an iterator `it` to control the generator</span></span><br><span class="line"><span class="keyword">var</span> it = foo();</span><br><span class="line"></span><br><span class="line"><span class="comment">// start `foo()` here!</span></span><br><span class="line">it.next();</span><br><span class="line">x;                      <span class="comment">// 2</span></span><br><span class="line">bar();</span><br><span class="line">x;                      <span class="comment">// 3</span></span><br><span class="line">it.next();              <span class="comment">// x: 3</span></span><br></pre></td></tr></table></figure>
<p><code>it = foo()</code>的时候函数主体其实是没有运行的，返回了一个Iterator给你控制函数的执行。第一次 调用 <code>it.next()</code>, 函数执行到<code>yeild</code>声明的位置，然后暂停, 第二次 <code>it.next()</code>的时候 继续执行，也就是 <code>console.log( &quot;x:&quot;, x )</code></p>
<h4 id="Iteration_Messaging">Iteration Messaging</h4><p><code>Iterator.next()</code>可以实现函数内部和外部的双向交流</p>
<p>例如 向函数内部发送参数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> y = x * (<span class="keyword">yield</span>); <span class="comment">// This yield is basically asking a question: "What value should I insert here?"</span></span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = foo( <span class="number">6</span> );</span><br><span class="line"></span><br><span class="line"><span class="comment">// start `foo(..)`</span></span><br><span class="line">it.next();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res = it.next( <span class="number">7</span> );</span><br><span class="line"></span><br><span class="line">res.value;      <span class="comment">// 42</span></span><br></pre></td></tr></table></figure></p>
<p>双向交流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> y = x * (<span class="keyword">yield</span> <span class="string">"Hello"</span>);    <span class="comment">// &lt;-- yield a value!</span></span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = foo( <span class="number">6</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res = it.next();    <span class="comment">// first `next()`, don't pass anything</span></span><br><span class="line">res.value;              <span class="comment">// "Hello"</span></span><br><span class="line"></span><br><span class="line">res = it.next( <span class="number">7</span> );     <span class="comment">// pass `7` to waiting `yield`</span></span><br><span class="line">res.value;              <span class="comment">// 42</span></span><br></pre></td></tr></table></figure>
<h4 id="Multiple_Iterators">Multiple Iterators</h4><p>错综复杂的一个例子</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">function *foo() &#123;</span><br><span class="line">    <span class="built_in">var</span> x = yield <span class="number">2</span>;</span><br><span class="line">    z++;</span><br><span class="line">    <span class="built_in">var</span> y = yield (x * z);</span><br><span class="line">    console.log( x, y, z );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> z = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> it1 = foo();</span><br><span class="line"><span class="built_in">var</span> it2 = foo();</span><br><span class="line"></span><br><span class="line"><span class="built_in">var</span> val1 = it1.<span class="built_in">next</span>().<span class="built_in">value</span>;            <span class="comment">// 2 &lt;-- yield 2</span></span><br><span class="line"><span class="built_in">var</span> val2 = it2.<span class="built_in">next</span>().<span class="built_in">value</span>;            <span class="comment">// 2 &lt;-- yield 2</span></span><br><span class="line"></span><br><span class="line">val1 = it1.<span class="built_in">next</span>( val2 * <span class="number">10</span> ).<span class="built_in">value</span>;     <span class="comment">// 40  &lt;-- x:20,  z:2</span></span><br><span class="line">val2 = it2.<span class="built_in">next</span>( val1 * <span class="number">5</span> ).<span class="built_in">value</span>;      <span class="comment">// 600 &lt;-- x:200, z:3</span></span><br><span class="line"></span><br><span class="line">it1.<span class="built_in">next</span>( val2 / <span class="number">2</span> );                   <span class="comment">// y:300</span></span><br><span class="line">                                        <span class="comment">// 20 300 3</span></span><br><span class="line">it2.<span class="built_in">next</span>( val1 / <span class="number">4</span> );                   <span class="comment">// y:10</span></span><br><span class="line">                                        <span class="comment">// 200 10 3</span></span><br></pre></td></tr></table></figure>
<p>如何让generator结束</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">something</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> nextVal;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nextVal === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                nextVal = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                nextVal = (<span class="number">3</span> * nextVal) + <span class="number">6</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">yield</span> nextVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cleanup clause</span></span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log( <span class="string">"cleaning up!"</span> );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>外部的break也会触发 finnally的执行 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> v <span class="keyword">of</span> something()) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log( v );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don't let the loop run forever!</span></span><br><span class="line">    <span class="keyword">if</span> (v &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 9 33 105 321 969</span></span><br><span class="line"><span class="comment">// cleaning up!</span></span><br></pre></td></tr></table></figure>
<p>或者可以执行 return()来结束generator</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> it = something();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> v <span class="keyword">of</span> it) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log( v );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// don't let the loop run forever!</span></span><br><span class="line">    <span class="keyword">if</span> (v &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(</span><br><span class="line">            <span class="comment">// complete the generator's iterator</span></span><br><span class="line">            it.return( <span class="string">"Hello World"</span> ).value</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// no `break` needed here</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1 9 33 105 321 969</span></span><br><span class="line"><span class="comment">// cleaning up!</span></span><br><span class="line"><span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure>
<h4 id="异步的Generator">异步的Generator</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">    ajax(</span><br><span class="line">        <span class="string">"http://some.url.1/?x="</span> + x + <span class="string">"&amp;y="</span> + y,</span><br><span class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="comment">// throw an error into `*main()`</span></span><br><span class="line">                it.throw( err );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// resume `*main()` with received `data`</span></span><br><span class="line">                it.next( data );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> text = <span class="keyword">yield</span> foo( <span class="number">11</span>, <span class="number">31</span> );</span><br><span class="line">        <span class="built_in">console</span>.log( text );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error( err );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = main();</span><br><span class="line"></span><br><span class="line"><span class="comment">// start it all up!</span></span><br><span class="line">it.next();</span><br></pre></td></tr></table></figure>
<h4 id="Generators_+_Promises">Generators + Promises</h4><p>结合 Gernerator(异步代码同步化而带来的易读)和Promise(可信赖)的好处</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x,y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> request(</span><br><span class="line">        <span class="string">"http://some.url.1/?x="</span> + x + <span class="string">"&amp;y="</span> + y</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> text = <span class="keyword">yield</span> foo( <span class="number">11</span>, <span class="number">31</span> );</span><br><span class="line">        <span class="built_in">console</span>.log( text );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error( err );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> it = main();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p = it.next().value;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wait for the `p` promise to resolve</span></span><br><span class="line">p.then(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123;</span><br><span class="line">        it.next( text );</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">        it.throw( err );</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>但是如果每一次都要那么麻烦的话，写代码也太痛苦了，我们来抽象这一个模式, 开发一个工具函数来减少我们的痛苦, 书中作者提供的一个函数<code>run()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thanks to Benjamin Gruenbaum (@benjamingr on GitHub) for</span></span><br><span class="line"><span class="comment">// big improvements here!</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = [].slice.call( <span class="built_in">arguments</span>, <span class="number">1</span>), it;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize the generator in the current context</span></span><br><span class="line">    it = gen.apply( <span class="keyword">this</span>, args );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return a promise for the generator completing</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</span><br><span class="line">        .then( <span class="function"><span class="keyword">function</span> <span class="title">handleNext</span>(<span class="params">value</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// run to the next yielded value</span></span><br><span class="line">            <span class="keyword">var</span> next = it.next( value );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> (<span class="function"><span class="keyword">function</span> <span class="title">handleResult</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">                <span class="comment">// generator has completed running?</span></span><br><span class="line">                <span class="keyword">if</span> (next.done) &#123;</span><br><span class="line">                    <span class="keyword">return</span> next.value;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// otherwise keep going</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve( next.value )</span><br><span class="line">                        .then(</span><br><span class="line">                            <span class="comment">// resume the async loop on</span></span><br><span class="line">                            <span class="comment">// success, sending the resolved</span></span><br><span class="line">                            <span class="comment">// value back into the generator</span></span><br><span class="line">                            handleNext,</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// if `value` is a rejected</span></span><br><span class="line">                            <span class="comment">// promise, propagate error back</span></span><br><span class="line">                            <span class="comment">// into the generator for its own</span></span><br><span class="line">                            <span class="comment">// error handling</span></span><br><span class="line">                            <span class="function"><span class="keyword">function</span> <span class="title">handleErr</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(</span><br><span class="line">                                    it.throw( err )</span><br><span class="line">                                )</span><br><span class="line">                                .then( handleResult );</span><br><span class="line">                            &#125;</span><br><span class="line">                        );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)(next);</span><br><span class="line">        &#125; );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这个函数，上面的例子就可以改写为</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">main</span><span class="params">()</span> <span class="comment">&#123;</span><br><span class="line">    // ..</span><br><span class="line">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="title">run</span><span class="params">( main )</span>;</span></span><br></pre></td></tr></table></figure>
<p> 是不是简洁了许多！</p>
<h5 id="处理Generator的并发">处理Generator的并发</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> r1 = <span class="keyword">yield</span> request( <span class="string">"http://some.url.1"</span> );</span><br><span class="line">    <span class="keyword">var</span> r2 = <span class="keyword">yield</span> request( <span class="string">"http://some.url.2"</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r3 = <span class="keyword">yield</span> request(</span><br><span class="line">        <span class="string">"http://some.url.3/?v="</span> + r1 + <span class="string">","</span> + r2</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log( r3 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// use previously defined `run(..)` utility</span></span><br><span class="line">run( foo );</span><br></pre></td></tr></table></figure>
<p>上面这个例子是可以正确运行的，但是仔细观察代码，你会发觉这段代码其实存在效率的问题，因为request其实是可以并发的，但是上例让request变成了串行了。改进一下</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">function</span> *foo() &#123;</span><br><span class="line">    var <span class="literal">p1</span> = request( <span class="string">"http://some.url.1"</span> )<span class="comment">;</span></span><br><span class="line">    var <span class="literal">p2</span> = request( <span class="string">"http://some.url.2"</span> )<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    var <span class="literal">r1</span> = yeild <span class="literal">p1</span><span class="comment">;</span></span><br><span class="line">    var <span class="literal">r2</span> = yeild <span class="literal">p2</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    var <span class="literal">p3</span> = <span class="keyword">yield </span>request(</span><br><span class="line">        <span class="string">"http://some.url.3/?v="</span> + <span class="literal">r1</span> + <span class="string">","</span> + <span class="literal">r2</span></span><br><span class="line">    )<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者使用<code>Promise.all()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// make both requests "in parallel," and</span></span><br><span class="line">    <span class="comment">// wait until both promises resolve</span></span><br><span class="line">    <span class="keyword">var</span> results = <span class="keyword">yield</span> <span class="built_in">Promise</span>.all( [</span><br><span class="line">        request( <span class="string">"http://some.url.1"</span> ),</span><br><span class="line">        request( <span class="string">"http://some.url.2"</span> )</span><br><span class="line">    ] );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> [r1,r2] = results;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> r3 = <span class="keyword">yield</span> request(</span><br><span class="line">        <span class="string">"http://some.url.3/?v="</span> + r1 + <span class="string">","</span> + r2</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log( r3 );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// use previously defined `run(..)` utility</span></span><br><span class="line">run( foo );</span><br></pre></td></tr></table></figure>
<h4 id="Generator_delegation">Generator delegation</h4><p>todo</p>
<h4 id="Generator_Concurrency">Generator Concurrency</h4><p>todo </p>
<h4 id="thunks_和_promise_和_generator">thunks 和 promise 和 generator</h4><h3 id="Performace">Performace</h3><p>我觉得这一章下面这一句话就足够了：</p>
<blockquote>
<p> non-critical path optimization is the root of all evil</p>
</blockquote>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/javascript/" rel="tag">#javascript</a>
          
            <a href="/tags/编程语言/" rel="tag">#编程语言</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/06/04/Haskell入门笔记/" rel="prev">Haskell入门笔记</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/04/12/Life-time-tracker表达的理念/" rel="next">Life Time Tracker的设计理念</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/default_avatar.jpg" alt="Andrew Zhang" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Andrew Zhang</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">40</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">40</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter1_:_Asynchrony:_Now_&_Later"><span class="nav-number">1.</span> <span class="nav-text">Chapter1 : Asynchrony: Now & Later</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Event_Loop"><span class="nav-number">1.1.</span> <span class="nav-text">Event Loop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#并行，并发"><span class="nav-number">1.2.</span> <span class="nav-text">并行，并发</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ES6中的Job_queue"><span class="nav-number">1.3.</span> <span class="nav-text">ES6中的Job queue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter2:_Callback"><span class="nav-number">2.</span> <span class="nav-text">Chapter2: Callback</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#callback的信任问题"><span class="nav-number">2.1.</span> <span class="nav-text">callback的信任问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter_3_Promises"><span class="nav-number">3.</span> <span class="nav-text">Chapter 3 Promises</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise如何解决信任问题"><span class="nav-number">3.1.</span> <span class="nav-text">Promise如何解决信任问题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#确定的执行顺序"><span class="nav-number">3.1.1.</span> <span class="nav-text">确定的执行顺序</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Chain_Flow"><span class="nav-number">3.2.</span> <span class="nav-text">Chain Flow</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Terminology:_Resolve,_Fulfill,_and_Reject"><span class="nav-number">3.2.1.</span> <span class="nav-text">Terminology: Resolve, Fulfill, and Reject</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Error_Handling"><span class="nav-number">3.3.</span> <span class="nav-text">Error Handling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise_Patterns"><span class="nav-number">3.4.</span> <span class="nav-text">Promise Patterns</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Promise-all([_-_])"><span class="nav-number">3.4.1.</span> <span class="nav-text">Promise.all([ .. ])</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Promise-race([_-_])"><span class="nav-number">3.4.2.</span> <span class="nav-text">Promise.race([ .. ])</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Promise_Limitations"><span class="nav-number">3.5.</span> <span class="nav-text">Promise Limitations</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter_4:_Generators"><span class="nav-number">4.</span> <span class="nav-text">Chapter 4: Generators</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Iteration_Messaging"><span class="nav-number">4.1.</span> <span class="nav-text">Iteration Messaging</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Multiple_Iterators"><span class="nav-number">4.2.</span> <span class="nav-text">Multiple Iterators</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#异步的Generator"><span class="nav-number">4.3.</span> <span class="nav-text">异步的Generator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Generators_+_Promises"><span class="nav-number">4.4.</span> <span class="nav-text">Generators + Promises</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#处理Generator的并发"><span class="nav-number">4.4.1.</span> <span class="nav-text">处理Generator的并发</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Generator_delegation"><span class="nav-number">4.5.</span> <span class="nav-text">Generator delegation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Generator_Concurrency"><span class="nav-number">4.6.</span> <span class="nav-text">Generator Concurrency</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#thunks_和_promise_和_generator"><span class="nav-number">4.7.</span> <span class="nav-text">thunks 和 promise 和 generator</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Performace"><span class="nav-number">5.</span> <span class="nav-text">Performace</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Andrew Zhang</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
